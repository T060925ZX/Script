#!/bin/bash

# æ£€æŸ¥æ˜¯å¦å®‰è£…äº† jqï¼ˆJSON è§£æå·¥å…·ï¼‰
if ! command -v jq &> /dev/null; then
    echo "jq æœªå®‰è£…ï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£…..."
    if command -v apt &> /dev/null; then
        sudo apt update && sudo apt install -y jq
    elif command -v yum &> /dev/null; then
        sudo yum install -y jq
    else
        echo "âŒ æ— æ³•è‡ªåŠ¨å®‰è£… jqï¼Œè¯·æ‰‹åŠ¨å®‰è£…åé‡è¯•ï¼"
        exit 1
    fi
fi

# å®šä¹‰ Yunzai çš„è·¯å¾„
YUNZAI_DIR="/root/Yunzai"

# å‡½æ•°ï¼šæ£€æŸ¥ TRSS-Yunzai çŠ¶æ€
check_status() {
    status=$(pm2 jlist | jq -r '.[] | select(.name == "TRSS-Yunzai") | .pm2_env.status' 2>/dev/null)
    if [[ "$status" == "online" ]]; then
        echo "âœ… TRSS-Yunzai æ­£åœ¨è¿è¡Œ"
        return 0
    else
        echo "âŒ TRSS-Yunzai æœªè¿è¡Œ"
        return 1
    fi
}

# å‡½æ•°ï¼šå¯åŠ¨ TRSS-Yunzai
start_yunzai() {
    if check_status; then
        echo "âš ï¸ TRSS-Yunzai å·²ç»åœ¨è¿è¡Œä¸­"
    else
        echo "ğŸ”§ å¯åŠ¨ TRSS-Yunzai..."
        cd "$YUNZAI_DIR" && pnpm start
    fi
}

# å‡½æ•°ï¼šåœæ­¢ TRSS-Yunzai
stop_yunzai() {
    if check_status; then
        echo "ğŸ›‘ åœæ­¢ TRSS-Yunzai..."
        pm2 stop TRSS-Yunzai
    else
        echo "âš ï¸ TRSS-Yunzai æœªåœ¨è¿è¡Œ"
    fi
}

# å‡½æ•°ï¼šé‡å¯ TRSS-Yunzai
restart_yunzai() {
    echo "ğŸ”„ é‡å¯ TRSS-Yunzai..."
    pm2 restart TRSS-Yunzai
}

# å‡½æ•°ï¼šåˆ é™¤ TRSS-Yunzai ä» PM2
delete_yunzai() {
    echo "ğŸ—‘ï¸ åˆ é™¤ TRSS-Yunzai ä» PM2..."
    pm2 delete TRSS-Yunzai
}

# å‡½æ•°ï¼šæŸ¥çœ‹æ—¥å¿—
view_log() {
    echo "ğŸ” æŸ¥çœ‹ TRSS-Yunzai æ—¥å¿—..."
    echo "æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹"
    tail -n 100 -f /root/.pm2/logs/TRSS-Yunzai-out.log
}

# å‡½æ•°ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ä½¿ç”¨æ–¹æ³•: yz [å‘½ä»¤]"
    echo ""
    echo "å¯ç”¨å‘½ä»¤:"
    echo "  start    - å¯åŠ¨ TRSS-Yunzai"
    echo "  stop     - åœæ­¢ TRSS-Yunzai"
    echo "  restart  - é‡å¯ TRSS-Yunzai"
    echo "  log      - æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  status   - æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo "  del      - ä» PM2 ä¸­åˆ é™¤ TRSS-Yunzai"
    echo "  help     - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
}

# ä¸»ç¨‹åº
case "$1" in
    "start")
        start_yunzai
        ;;
    "stop")
        stop_yunzai
        ;;
    "restart")
        restart_yunzai
        ;;
    "log")
        view_log
        ;;
    "status")
        check_status
        ;;
    "del")
        delete_yunzai
        ;;
    "help"|"")
        show_help
        ;;
    *)
        echo "âŒ æœªçŸ¥å‘½ä»¤: $1"
        echo "ä½¿ç”¨ 'yz help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
        exit 1
        ;;
esac
